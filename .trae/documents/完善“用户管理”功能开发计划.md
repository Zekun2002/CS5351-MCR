## 目标与边界
- 目标：实现用户管理的增删改查、角色分配、权限校验、查询与导出，并提供用户ID列表给任务模块。
- 边界：不修改现有数据表结构（users、user_roles、role_permissions），不新增字段（不实现启用/禁用、头像、手机号等）。

## 不改库的实现策略
- 所有功能基于现有字段完成：`users(user_id, username, password_hash, email, role, created_at, updated_at)`、`user_roles(user_id, role_id)`、`role_permissions(role_id, permission_code, ...)`。
- 角色分配使用 `user_roles` 维护多对多关系；权限校验基于 `role_permissions.permission_code` 与若依的 `@PreAuthorize`。
- 状态相关功能（启用/禁用）暂不提供；前端不展示状态列与按钮。

## 后端接口（ruoyi-admin 模块）
- 控制器：`com.ruoyi.web.controller.system.UsersController`，前缀 `/system/users`
- 接口：
  - `GET /list`：分页查询，支持 `username/email/role`；返回 `Users` 列表（不含 `passwordHash`）。
  - `GET /{userId}`：详情。
  - `POST /`：新增（校验 `username/email` 唯一，密码由上层业务生成 hash）。
  - `PUT /`：编辑（不允许直接修改 `passwordHash`，如需修改提供独立接口）。
  - `DELETE /{userIds}`：批量删除。
  - `PUT /role/{userId}`：分配角色（覆盖式或增量式，按需选择）。
  - `GET /ids`：返回 `List<Long>` 用户ID列表（复用现有服务）。
- 权限码：`system:users:query`、`system:users:add`、`system:users:edit`、`system:users:remove`、`system:users:assignRole`。
- Service/Mapper 扩展：
  - `List<Long> selectUserIdList()`（已实现，可直接暴露控制器）；
  - `List<Users> selectUsersList(Users query)`（已生成，用于分页）；
  - `int assignRoles(Long userId, List<Long> roleIds)`：Service 函数，Mapper XML 实现 `delete from user_roles where user_id = ?` + 批量 `insert`；
  - `List<String> selectPermissionCodesByUserId(Long userId)`：Mapper 联合 `user_roles` 与 `role_permissions`，供 `@ss.hasPermi` 使用或做轻量验证。

## SQL 说明（不改表）
- 用户分页：`select ... from users where username like ? and email = ? and role = ?`。
- 分配角色：`delete from user_roles where user_id = ?`；`insert into user_roles(user_id, role_id) values(?, ?)` 批量。
- 用户权限：`select distinct rp.permission_code from role_permissions rp join user_roles ur on rp.role_id = ur.role_id where ur.user_id = ?`。

## 前端实现（ruoyi-ui / Vue2 + Element-UI）
- 视图：`src/views/system/users/index.vue`
  - 表格列：用户名、邮箱、角色、创建/更新时间；不展示状态列。
  - 搜索表单：`username/email/role`；分页。
  - 操作：新增、编辑、删除、批量删除、分配角色；按钮加 `v-hasPermi`。
- API：`src/api/system/users.js`
  - `listUsers(params)`、`getUsers(id)`、`addUsers(data)`、`updateUsers(data)`、`delUsers(ids)`、`assignRoles(userId, roleIds)`、`getUserIds()`。
- 路由/菜单：新增“用户管理”菜单项并绑定权限码。

## 安全与合规
- 后端控制器返回时去除 `passwordHash`；禁止明文密码入库与输出。
- 所有写操作带权限校验与操作日志；参数校验（用户名/邮箱唯一性）。

## 测试计划
- 单元测试：Service 的 `assignRoles`、`selectUserIdList`、`selectPermissionCodesByUserId`。
- 集成测试：控制器鉴权与分页查询、CRUD 正常与异常路径。
- 前端联调：列表/搜索、CRUD、角色分配；基于权限码的按钮显示控制。

## 交付里程碑
1. 后端接口与权限码落地，`/list`、`/ids`、基础 CRUD 与角色分配实现。
2. 前端页面与 API 完成并联通后端，权限控制生效。
3. 增加唯一性校验/操作日志完善，通过测试。

## 已有实现可直接复用
- 用户ID列表服务：`IUsersService.selectUserIdList()` 与 Mapper/XML 已添加（参考：`ruoyi-system/.../IUsersService.java:60`、`UsersServiceImpl.java:92`、`UsersMapper.java:61`、`UsersMapper.xml:81`）。

## 需要你确认的实现选项
- 角色分配方式：覆盖式（清空后重新写入）或增量式（新增删除差集）。如不指定，默认覆盖式（与若依生成器风格一致）。
- 用户名/邮箱的唯一性校验是否需要后端强校验并返回具体错误码？默认需要。